{% extends 'base.html' %}

{% block content %}
<div class="card">
  <h2>Admin Dashboard</h2>
  <p>Total tickets: <strong>{{ total }}</strong> â€¢ Pending: <strong>{{ unpaid }}</strong></p>

  <div class="admin-controls" style="margin:12px 0;">
    <button class="btn filter-btn" data-filter="all">All</button>
    <button class="btn filter-btn" data-filter="pending">Pending</button>
    <button class="btn filter-btn" data-filter="paid">Paid</button>

    <form method="post" action="{{ url_for('admin_clear_tickets') }}" style="display:inline-block; float:right;" onsubmit="return confirm('This will permanently delete all tickets. Are you sure?');">
      <button type="submit" class="btn alt">Clear All Tickets</button>
    </form>
  </div>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Registered</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tickets %}
        <tr data-paid="{{ 1 if t.paid else 0 }}">
          <td>{{ t.id }}</td>
          <td>{{ t.name }}</td>
          <td>{{ t.email }}</td>
          <td>{{ t.phone }}</td>
          <td>{{ t.registered_at or t.created_at }}</td>
          <td>
            {% if t.paid %}
              <span class="label success">Paid</span>
            {% else %}
              <span class="label warning">Pending</span>
            {% endif %}
          </td>
          <td>
            <a class="btn small" href="{{ url_for('ticket', id=t.id) }}">View</a>
            {% if not t.paid %}
              <form method="post" action="{{ url_for('admin_confirm') }}" style="display:inline;">
                <input type="hidden" name="ticket_id" value="{{ t.id }}">
                <button type="submit" class="btn small alt">Confirm</button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const f = btn.getAttribute('data-filter');
      document.querySelectorAll('table.table tbody tr').forEach(row=>{
        const paid = row.getAttribute('data-paid');
        if(f === 'all') row.style.display = '';
        else if(f === 'pending') row.style.display = (paid === '0') ? '' : 'none';
        else if(f === 'paid') row.style.display = (paid === '1') ? '' : 'none';
      });
    });
  });
</script>
{% endblock %}